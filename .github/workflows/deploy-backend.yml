name: Deploy Backend to DigitalOcean

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy backend files to Droplet
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          source: 'backend/*'
          target: '/home/parsons/backend/'
          strip_components: 1
          overwrite: true
          rm: false

      - name: Deploy and restart service
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          command_timeout: 5m
          script: |
            set -e  # Exit on error, but we'll handle specific cases

            cd /home/parsons/backend

            # Stop parsons service (ignore errors if not running)
            echo "Stopping parsons service..."
            systemctl stop parsons 2>/dev/null || echo "Service not running"

            # Kill any processes using port 8000 (ignore errors if none found)
            echo "Checking for processes on port 8000..."
            if lsof -ti:8000 >/dev/null 2>&1; then
              echo "Killing processes on port 8000..."
              lsof -ti:8000 | xargs -r kill -9 2>/dev/null || true
              sleep 3
            else
              echo "No processes on port 8000"
            fi

            # Alternative cleanup (ignore errors)
            pkill -9 -f "gunicorn.*main:app" 2>/dev/null || true
            pkill -9 -f "uvicorn.*main:app" 2>/dev/null || true
            pkill -9 -f "python.*main.py" 2>/dev/null || true

            # Wait for cleanup
            sleep 2

            # Verify port is free
            if lsof -Pi :8000 -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "❌ Port 8000 still in use"
              lsof -Pi :8000 -sTCP:LISTEN
              exit 1
            else
              echo "✅ Port 8000 is free"
            fi

            # Backup sessions check
            if [ -d "data/sessions" ]; then
              echo "✅ Sessions directory exists ($(ls data/sessions/*.json 2>/dev/null | wc -l) files)"
            else
              echo "Creating sessions directory..."
              mkdir -p data/sessions
            fi

            # Update dependencies
            echo "Installing dependencies..."
            if [ ! -d "venv" ]; then
              echo "Creating virtual environment..."
              python3 -m venv venv
            fi
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            # Create/update environment file
            cat > .env << 'EOF'
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            PORT=8000
            ENVIRONMENT=production
            EOF

            # Start service
            echo "Starting parsons service..."
            systemctl start parsons

            # Wait and check status
            sleep 10
            if systemctl is-active --quiet parsons; then
              echo "✅ Service started successfully"
              systemctl status parsons --no-pager -l
              
              # Test API
              echo "Testing API endpoint..."
              if curl -f http://localhost:8000/ > /dev/null 2>&1; then
                echo "✅ API responding"
              else
                echo "⚠️ API not responding yet, checking logs..."
                journalctl -u parsons --no-pager -n 20
              fi
            else
              echo "❌ Service failed to start"
              echo "=== Service Status ==="
              systemctl status parsons --no-pager -l
              echo "=== Recent Logs ==="
              journalctl -u parsons --no-pager -n 50
              exit 1
            fi
